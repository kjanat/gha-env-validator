name: Publish to npm

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Dry run (don't actually publish)"
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.plan.outputs.release }}
      dry-run: ${{ steps.plan.outputs.dry-run }}
      package: ${{ steps.plan.outputs.package }}
      version: ${{ steps.plan.outputs.version }}
      url: ${{ steps.plan.outputs.url }}

    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
      - name: Plan
        id: plan
        run: |
          PKG_NAME="$(bun pm pkg get name | tr -d '"')"
          PKG_VERSION="$(bun pm pkg get version | tr -d '"')"
          PKG_URL="https://www.npmjs.com/package/${PKG_NAME}"
          IS_DRY_RUN="false"
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" && "${{ github.event.inputs.dry-run }}" == "true" ]]; then
            IS_DRY_RUN="true"
          fi
          IS_PUBLISH=$([[ "$IS_DRY_RUN" == "false" ]] && echo "true" || echo "false")
          {
            printf "## ðŸ“¦ Plan\n\n"
            printf "**Package:**  \`%s\`  \n"     "$PKG_NAME"
            printf "**Version:**  \`%s\`  \n"     "$PKG_VERSION"
            printf "**Event:**    \`%s\`  \n"     "$GITHUB_REF"
            printf "**Dry run:**  \`%s\`  \n"     "$IS_DRY_RUN"
            printf "**Publish:**  \`%s\`  \n\n"   "$IS_PUBLISH"
            printf "[View on npm â†’](%s \"%s\")\n" "$PKG_URL" "View ${PKG_NAME} on npm"
          } >> "$GITHUB_STEP_SUMMARY"
          {
            echo "release=${IS_PUBLISH}";
            echo "release=${IS_PUBLISH}";
            echo "dry-run=${IS_DRY_RUN}";
            echo "package=${PKG_NAME}";
            echo "version=${PKG_VERSION}";
            echo "url=${PKG_URL}"
          } >> "$GITHUB_OUTPUT"

  publish:
    runs-on: ubuntu-latest
    needs: plan
    name: ${{ needs.plan.outputs.release == 'true' && 'Publish' || 'Publish (Dry run)' }}
    steps:
      - uses: actions/checkout@v5
      # NPM for OIDC
      - uses: actions/setup-node@v6
        with:
          node-version: "lts/*"
          registry-url: "https://registry.npmjs.org"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Run tests
        run: bun test

      - name: Verify build
        if: ${{ needs.plan.outputs.release != 'true' }}
        run: |
          ls -lh dist/
          test -f dist/index.mjs || exit 1
          test -f dist/index.d.mts || exit 1

      - name: Dry run publish
        id: dry-run
        if: ${{ needs.plan.outputs.dry-run == 'true' }}
        run: npm publish --dry-run --provenance

      - name: Publish to npm
        id: publish
        if: ${{ needs.plan.outputs.release == 'true' }}
        run: npm publish --access public --provenance

      - name: Summary
        if: ${{ !cancelled() }}
        run: |
          # Figure out which step actually ran
          if [ "${{ steps.publish.outcome }}" != "" ] && [ "${{ steps.publish.outcome }}" != "skipped" ]; then
            OUTCOME="${{ steps.publish.outcome }}"
          elif [ "${{ steps['dry-run'].outcome }}" != "" ] && [ "${{ steps['dry-run'].outcome }}" != "skipped" ]; then
            OUTCOME="${{ steps['dry-run'].outcome }}"
          else
            OUTCOME="skipped"
          fi

          if [ "$OUTCOME" = "success" ]; then
            RESULT="âœ… Success"
          else
            RESULT="âŒ Failed (${OUTCOME})"
          fi

          {
            echo "## ðŸ“¦ Published";
            echo "";
            echo "**Package:** \`${PKG_NAME}\`  ";
            echo "**Version:** \`${RELEASE_VERSION}\`  ";
            echo "**Event:** \`${GITHUB_EVENT_NAME}\`  ";
            echo "**Result:** \`${RESULT}\`";
            echo "";
            echo "[View on npm â†’](${RELEASE_URL} \"View ${PKG_NAME} on npm\")"
          } >> "$GITHUB_STEP_SUMMARY"
        env:
          PKG_NAME: ${{ needs.plan.outputs.package }}
          RELEASE_VERSION: ${{ needs.plan.outputs.version }}
          RELEASE_URL: ${{ needs.plan.outputs.url }}
